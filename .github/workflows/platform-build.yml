name: Build StreamNative Platform
on:
  push:
    branches:
      - release/platform

jobs:
  build:
    name: build sn platform
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v1

      - name: get dependence files
        run: |
          cd platform/scripts
          ./test.sh && ./get-master-code.sh

      - name: build tarball
        run: |
          cd platform/
          version=`cat VERSION`
          tar -czvf sn-platform-$version.tar.gz sn-platform
          rm -rf sn-platform
          ls -a

#      - name: build zip
#        run: |
#          cd platform/
#          zip â€“r sn-platform.zip sn-platform/*

      - name: publish code to github
#        uses: skx/github-action-publish-binaries@release-0.11
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#          TAG: 0.0.1
#        with:
#          args: 'sn-platform*'
        run: |
          docker build -f platform/scripts/Dockerfile -t sn-platform .
          docker run -e ACCESS_TOKEN=${{ secrets.ACCESS_TOKEN }} -v $(pwd):/sn-platform sn-platform sh -c 'upload-script.sh /sn-platform/platform/sn-platform-*'
